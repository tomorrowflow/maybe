<%= content_for :header_nav do %>
  <%= render "retirement_scenarios/wizard_nav", current_step: @step %>
<% end %>

<%= content_for :prev_nav do %>
  <button type="button"
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg hover:bg-gray-100 theme-dark:hover:bg-gray-700"
          onclick="document.dispatchEvent(new CustomEvent('retirement-wizard:back'))">
    <%= icon "arrow-left", class: "w-5 h-5 text-secondary" %>
  </button>
<% end %>

<%= content_for :cancel_path, retirement_scenarios_path %>

<div data-controller="retirement-wizard"
     data-retirement-wizard-current-step-value="<%= @step %>"
     data-retirement-wizard-exit-path-value="<%= retirement_scenarios_path %>">
  <div class="space-y-4">
    <%= styled_form_with model: @scenario, url: retirement_scenarios_path, class: "space-y-6" do |form| %>
      <!-- Step 1: Basics -->
      <div data-retirement-wizard-target="step" data-step="basics" class="<%= 'hidden' unless @step == 'basics' %>">
        <div class="text-center space-y-2 mb-8">
          <h1 class="text-3xl text-primary font-medium">Let's plan your retirement</h1>
          <p class="text-secondary text-sm max-w-md mx-auto">
            Start by setting your basic retirement goals and target expenses.
          </p>
        </div>

        <div class="mx-auto max-w-lg space-y-4">
          <%= form.text_field :name,
                              label: "Plan Name",
                              placeholder: "My Retirement Plan",
                              required: true %>

          <%= form.number_field :retirement_monthly_expenses,
                                label: "Monthly Expenses in Retirement",
                                placeholder: "4000",
                                min: 0,
                                step: 1,
                                required: true %>

          <div class="border border-tertiary rounded-lg p-4 flex gap-3">
            <%= icon "info", class: "w-5 h-5 text-secondary shrink-0 mt-0.5" %>
            <div class="space-y-1 text-sm">
              <h4 class="text-primary font-medium">What should I include?</h4>
              <p class="text-secondary">
                Include all expected monthly costs: housing, food, healthcare, travel, hobbies, and any regular expenses you expect in retirement.
              </p>
            </div>
          </div>

          <div class="pt-4">
            <button type="button"
                    class="font-medium whitespace-nowrap inline-flex items-center gap-1 rounded-lg w-full justify-center px-3 py-2 text-sm text-inverse bg-inverse hover:bg-inverse-hover"
                    data-action="click->retirement-wizard#nextStep"
                    data-wizard-next-step="income">
              Continue
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Income -->
      <div data-retirement-wizard-target="step" data-step="income" class="<%= 'hidden' unless @step == 'income' %>">
        <div class="text-center space-y-2 mb-8">
          <h1 class="text-3xl text-primary font-medium">Your retirement income</h1>
          <p class="text-secondary text-sm max-w-md mx-auto">
            Enter your expected pension and income sources.
          </p>
        </div>

        <div class="mx-auto max-w-lg space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <%= form.date_field :salary_end_date,
                                label: "Last Day of Salary" %>

            <%= form.number_field :current_annual_salary,
                                  label: "Current Annual Salary",
                                  placeholder: "75000",
                                  min: 0,
                                  step: 100 %>
          </div>

          <div class="border-t border-secondary pt-4">
            <p class="text-sm font-medium text-primary mb-3">State Pension (Gesetzliche Rente)</p>

            <div class="grid grid-cols-2 gap-4">
              <%= form.date_field :gesetzliche_rente_start_date,
                                  label: "Start Date" %>

              <%= form.number_field :gesetzliche_rente_monthly,
                                    label: "Monthly Amount",
                                    placeholder: "1500",
                                    min: 0,
                                    step: 10 %>
            </div>
          </div>

          <div class="border-t border-secondary pt-4">
            <p class="text-sm font-medium text-primary mb-3">Private Pension Plans</p>

            <% if @scenario.pension_sources.any? %>
              <div class="space-y-3">
                <%= form.fields_for :pension_sources do |ps_form| %>
                  <% pension_source = ps_form.object %>
                  <%= ps_form.hidden_field :account_id %>
                    <div class="bg-surface-inset rounded-lg p-4">
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                          <%= icon "line-chart", class: "w-5 h-5 text-blue-600" %>
                          <div>
                            <div class="font-medium text-primary"><%= pension_source.account.name %></div>
                            <div class="text-xs text-secondary"><%= pension_source.account.long_subtype_label %></div>
                          </div>
                        </div>
                        <div class="text-right">
                          <div class="text-sm font-medium text-primary"><%= format_money pension_source.account.balance_money %></div>
                          <div class="text-xs text-secondary">Current Value</div>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <%= ps_form.number_field :expected_monthly_payout,
                                                   label: "Expected Monthly Payout",
                                                   placeholder: pension_source.account_expected_monthly_payout || "500",
                                                   min: 0,
                                                   step: 10 %>
                          <% if pension_source.account_expected_monthly_payout.present? && pension_source.expected_monthly_payout.blank? %>
                            <p class="text-xs text-green-600 mt-1">From account: <%= number_to_currency(pension_source.account_expected_monthly_payout) %></p>
                          <% end %>
                        </div>
                        <div>
                          <%= ps_form.date_field :payout_start_date,
                                                 label: "Payout Start Date" %>
                          <% if pension_source.account_retirement_date.present? && pension_source.payout_start_date.blank? %>
                            <p class="text-xs text-green-600 mt-1">From account: <%= pension_source.account_retirement_date.strftime("%b %Y") %></p>
                          <% end %>
                        </div>
                      </div>
                    </div>
                <% end %>
              </div>

              <div class="border border-tertiary rounded-lg p-3 mt-3 flex gap-3">
                <%= icon "info", class: "w-4 h-4 text-secondary shrink-0 mt-0.5" %>
                <p class="text-xs text-secondary">
                  Values are pre-filled from your pension account settings. You can override them here for this scenario.
                </p>
              </div>
            <% else %>
              <div class="bg-surface-inset rounded-lg p-4 text-center">
                <p class="text-sm text-secondary mb-2">No pension accounts found.</p>
                <p class="text-xs text-secondary">
                  Add Riester, RÃ¼rup, or Betriebsrente accounts to your portfolio to include them here.
                </p>
              </div>
            <% end %>
          </div>

          <div class="border-t border-secondary pt-4">
            <p class="text-sm font-medium text-primary mb-3">Other Pension Sources</p>
            <div class="grid grid-cols-2 gap-4">
              <%= form.date_field :other_pension_start_date,
                                  label: "Start Date" %>

              <%= form.number_field :other_pension_monthly,
                                    label: "Monthly Amount",
                                    placeholder: "500",
                                    min: 0,
                                    step: 10 %>
            </div>
          </div>

          <div class="pt-4">
            <button type="button"
                    class="font-medium whitespace-nowrap inline-flex items-center gap-1 rounded-lg w-full justify-center px-3 py-2 text-sm text-inverse bg-inverse hover:bg-inverse-hover"
                    data-action="click->retirement-wizard#nextStep"
                    data-wizard-next-step="portfolio">
              Continue
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Portfolio -->
      <div data-retirement-wizard-target="step" data-step="portfolio" class="<%= 'hidden' unless @step == 'portfolio' %>">
        <div class="text-center space-y-2 mb-8">
          <h1 class="text-3xl text-primary font-medium">Portfolio strategy</h1>
          <p class="text-secondary text-sm max-w-md mx-auto">
            Set your withdrawal rate and growth assumptions.
          </p>
        </div>

        <div class="mx-auto max-w-lg space-y-4">
          <%= form.number_field :portfolio_withdrawal_rate,
                                label: "Safe Withdrawal Rate (%)",
                                placeholder: "4.0",
                                step: 0.1,
                                min: 0.1,
                                max: 10,
                                required: true %>

          <div class="border border-tertiary rounded-lg p-4 flex gap-3">
            <%= icon "info", class: "w-5 h-5 text-secondary shrink-0 mt-0.5" %>
            <div class="space-y-1 text-sm">
              <h4 class="text-primary font-medium">What's a safe withdrawal rate?</h4>
              <p class="text-secondary">
                The percentage you can withdraw annually without depleting your portfolio. Conservative: 3-3.5%, Moderate: 4%, Aggressive: 5%
              </p>
            </div>
          </div>

          <div class="border-t border-secondary pt-4">
            <p class="text-sm font-medium text-primary mb-3">Growth Assumptions</p>

            <div class="grid grid-cols-2 gap-4">
              <%= form.number_field :portfolio_growth_rate,
                                    label: "Expected Annual Return (%)",
                                    placeholder: "7.0",
                                    step: 0.1,
                                    min: -20,
                                    max: 50 %>

              <%= form.number_field :inflation_rate,
                                    label: "Expected Inflation (%)",
                                    placeholder: "3.0",
                                    step: 0.1,
                                    min: 0,
                                    max: 20 %>
            </div>

            <div class="mt-4">
              <%= form.number_field :monthly_contribution,
                                    label: "Monthly Contribution",
                                    placeholder: "Leave blank to auto-calculate",
                                    min: 0,
                                    step: 10 %>
              <p class="text-xs text-secondary mt-1">If blank, we'll calculate from your savings history.</p>
            </div>
          </div>

          <div class="border border-blue-200 bg-blue-50 theme-dark:border-blue-800 theme-dark:bg-blue-900/20 rounded-lg p-4 flex gap-3">
            <%= icon "trending-up", class: "w-5 h-5 text-blue-600 shrink-0 mt-0.5" %>
            <div class="space-y-1 text-sm">
              <h4 class="text-primary font-medium">Compound Growth</h4>
              <p class="text-secondary">
                Your portfolio's growth accelerates over time thanks to compound returns on both your contributions and investment gains.
              </p>
            </div>
          </div>

          <div class="pt-4">
            <%= form.submit "Create Plan" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
