<%# locals: (account:) %>

<% bauspar = account.bauspar_contract %>

<div class="space-y-6">
  <%# Contract Overview %>
  <div class="grid grid-cols-3 gap-2">
    <%= summary_card title: "Bausparsumme" do %>
      <%= format_money Money.new(bauspar.bausparsumme, account.currency) %>
    <% end %>

    <%= summary_card title: "Current Balance" do %>
      <%= format_money account.balance_money %>
    <% end %>

    <%= summary_card title: "Current Phase" do %>
      <div><%= bauspar.phase_description %></div>
    <% end %>
  </div>

  <%# Savings Progress (only in savings phase) %>
  <% if bauspar.saving_phase? %>
    <div class="bg-container rounded-lg p-4 border border-primary">
      <h3 class="text-sm font-medium text-secondary mb-3">Savings Progress</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
          <div class="text-xs text-tertiary">Progress</div>
          <div class="text-lg font-semibold">
            <%= number_to_percentage(bauspar.savings_progress_percent, precision: 1) %>
          </div>
        </div>
        <div>
          <div class="text-xs text-tertiary">Target (<%= bauspar.savings_target_percent %>%)</div>
          <div class="text-lg font-semibold">
            <%= format_money bauspar.savings_target_amount %>
          </div>
        </div>
        <div>
          <div class="text-xs text-tertiary">Remaining</div>
          <div class="text-lg font-semibold">
            <%= format_money bauspar.available_loan_amount %>
          </div>
        </div>
        <% if bauspar.monthly_contribution.present? %>
          <div>
            <div class="text-xs text-tertiary">Monthly Contribution</div>
            <div class="text-lg font-semibold">
              <%= format_money Money.new(bauspar.monthly_contribution, account.currency) %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Progress bar %>
      <div class="mt-4">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-green-500 h-2.5 rounded-full" style="width: <%= [bauspar.savings_progress_percent, 100].min %>%"></div>
        </div>
      </div>
    </div>
  <% end %>

  <%# Allocation Readiness (only in savings phase) %>
  <% if bauspar.saving_phase? %>
    <div class="bg-container rounded-lg p-4 border border-primary">
      <h3 class="text-sm font-medium text-secondary mb-3">Allocation Readiness (Zuteilungsreife)</h3>
      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <span class="text-sm">Savings Target Met</span>
          <% if bauspar.savings_progress_percent >= 100 %>
            <%= icon "check-circle", class: "w-5 h-5 text-green-500" %>
          <% else %>
            <%= icon "circle", class: "w-5 h-5 text-gray-300" %>
          <% end %>
        </div>

        <% if bauspar.minimum_savings_period_months.present? %>
          <div class="flex items-center justify-between">
            <span class="text-sm">
              Minimum Period (<%= bauspar.minimum_savings_period_months %> months)
              <% if bauspar.months_until_minimum_period > 0 %>
                <span class="text-xs text-tertiary">- <%= bauspar.months_until_minimum_period %> months remaining</span>
              <% end %>
            </span>
            <% if bauspar.minimum_savings_period_met? %>
              <%= icon "check-circle", class: "w-5 h-5 text-green-500" %>
            <% else %>
              <%= icon "circle", class: "w-5 h-5 text-gray-300" %>
            <% end %>
          </div>
        <% end %>

        <% if bauspar.minimum_bewertungszahl.present? %>
          <div class="flex items-center justify-between">
            <span class="text-sm">
              Bewertungszahl
              <span class="text-xs text-tertiary">
                (<%= bauspar.current_bewertungszahl || 0 %> / <%= bauspar.minimum_bewertungszahl %>)
              </span>
            </span>
            <% if bauspar.bewertungszahl_met? %>
              <%= icon "check-circle", class: "w-5 h-5 text-green-500" %>
            <% else %>
              <%= icon "circle", class: "w-5 h-5 text-gray-300" %>
            <% end %>
          </div>
        <% end %>

        <% if bauspar.allocation_ready? %>
          <div class="mt-3 p-2 bg-green-50 rounded text-sm text-green-800">
            Your contract is ready for allocation (zuteilungsreif)!
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Loan Information (allocated or loan phase) %>
  <% if bauspar.allocated_phase? || bauspar.loan_phase? %>
    <div class="bg-container rounded-lg p-4 border border-primary">
      <h3 class="text-sm font-medium text-secondary mb-3">Loan Details</h3>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="text-xs text-tertiary">Available Loan Amount</div>
          <div class="text-lg font-semibold">
            <%= format_money bauspar.available_loan_amount %>
          </div>
        </div>
        <% if bauspar.loan_interest_rate.present? %>
          <div>
            <div class="text-xs text-tertiary">Loan Interest Rate</div>
            <div class="text-lg font-semibold">
              <%= number_to_percentage(bauspar.loan_interest_rate, precision: 3) %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Contract Details %>
  <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
    <% if bauspar.provider.present? %>
      <%= summary_card title: "Bausparkasse" do %>
        <%= bauspar.provider %>
      <% end %>
    <% end %>

    <% if bauspar.contract_number.present? %>
      <%= summary_card title: "Contract Number" do %>
        <%= bauspar.contract_number %>
      <% end %>
    <% end %>

    <% if bauspar.tariff_name.present? %>
      <%= summary_card title: "Tariff" do %>
        <%= bauspar.tariff_name %>
      <% end %>
    <% end %>

    <% if bauspar.contract_start_date.present? %>
      <%= summary_card title: "Contract Start" do %>
        <%= bauspar.contract_start_date.strftime("%B %Y") %>
        <% if bauspar.contract_duration_years %>
          <div class="text-xs text-tertiary"><%= bauspar.contract_duration_years %> years</div>
        <% end %>
      <% end %>
    <% end %>

    <% if bauspar.expected_allocation_date.present? && bauspar.saving_phase? %>
      <%= summary_card title: "Expected Allocation" do %>
        <%= bauspar.expected_allocation_date.strftime("%B %Y") %>
        <% if bauspar.years_until_allocation && bauspar.years_until_allocation > 0 %>
          <div class="text-xs text-tertiary">in <%= bauspar.years_until_allocation %> years</div>
        <% end %>
      <% end %>
    <% end %>

    <% if bauspar.actual_allocation_date.present? %>
      <%= summary_card title: "Allocation Date" do %>
        <%= bauspar.actual_allocation_date.strftime("%B %d, %Y") %>
      <% end %>
    <% end %>
  </div>

  <%# Interest Rates %>
  <% if bauspar.savings_interest_rate.present? || bauspar.loan_interest_rate.present? %>
    <div class="grid grid-cols-2 gap-2">
      <% if bauspar.savings_interest_rate.present? %>
        <%= summary_card title: "Savings Interest (Guthabenzins)" do %>
          <%= number_to_percentage(bauspar.savings_interest_rate, precision: 3) %>
        <% end %>
      <% end %>

      <% if bauspar.loan_interest_rate.present? %>
        <%= summary_card title: "Loan Interest (Darlehenszins)" do %>
          <%= number_to_percentage(bauspar.loan_interest_rate, precision: 3) %>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%# State Subsidies %>
  <% if bauspar.has_subsidies? %>
    <div class="bg-container rounded-lg p-4 border border-primary">
      <h3 class="text-sm font-medium text-secondary mb-3">State Subsidies (FÃ¶rderung)</h3>
      <div class="flex flex-wrap gap-2">
        <% bauspar.active_subsidies.each do |subsidy| %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
            <%= icon "check", class: "w-3 h-3 mr-1" %>
            <%= subsidy %>
          </span>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<div class="flex justify-center py-8">
  <%= render DS::Link.new(
    text: "Edit Building Savings details",
    variant: "ghost",
    href: edit_bauspar_contract_path(account),
    frame: :modal
  ) %>
</div>
